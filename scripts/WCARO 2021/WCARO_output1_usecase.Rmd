---
title: "WCARO output 1 use case 1"
author: "Akvo - data science"
date: "11/9/2021"
output: 
  html_document:
    number_sections: TRUE
    css: style.css
    # css: akvostyle.css
    code_folding: "hide"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

options(scipen = 999)

# Library
library(here)
library(tidyverse)
library(data.table)
library(readxl)
library(sf)
library(sp)
library(rgdal)
library(maps)
library(kableExtra)
library(ggplot2)

### CIRCLES!
wp_2016_processed <- read.csv2(here("data/processed","wp_2016_processed.csv"))

# Selection of wp 2016 data
wp_2016_sub <- wp_2016_processed %>% 
  dplyr::select("ADM2", #"ADM3", "ADM4", "ADM5",
    "Water.point.Name", 
    "Latitude", "Longitude",
    "Functionality",
    "sdg_improved_source",
    "sphere_nr_people") %>% 
  unique() %>%
  mutate(sdg_improved_source = recode(
         sdg_improved_source,
         "Improved" = "improved",
         "Unimproved" = "unimproved",
         .default="unimproved")) %>%
   filter(ADM2 == "Kambia") %>%
  mutate(Functionality = recode(
    Functionality,
    "No - Broken down" = "Not functional",
    "No - Still under construction" = "Not functional",
    "No - Under rehabilitation" = "Not functional",
    "Yes – Functional (but not in use)" = "Not functional",
    "Yes - But damaged" = "Not functional",
    "Yes – Functional (and in use)" = "Functional and in use")) 

```

# Introduction 

Access to an improved water source is the first step towards achieving safe water coverage for a population. When different methodologies are used to report coverage, wide discrepancies appear in the reported figures for people with access to safe water and those left unserved. However, planners and policy makers require correct and updated information to estimate real needs and to assess the scale of vulnerabilities across unserved / underserved populations, as well as to make projections for future allocations. In this overview, we demonstrate how such differences appear by using three different ways of estimating water access in the region of Kambia.  
 
Country governments are required to report their progress of WASH services on all the three key indicators of SDG6  and grade their level of services in the JMP ladder. While it is relatively easier to measure water coverage by recording the number of water points that are installed, reporting on ‘basic’ water services according to the  JMP requires also recording whether a round trip to the water point takes less than  30 minutes.  For higher levels of the JMP ladder where water safety and reliability need to be reported upon, the parameters are stricter and require more detailed information.

*See Annex 1 and the footnote for more information about the data sources used.*

# Methodology
Many  countries continue to face challenges in recording and updating their water coverage data, either due to lack of resources or the capacity to collect information about the SDG parameters. Also, during reporting, measurements of water coverage seldom take into account aspects of functionality of water points or the density of population in  locations of the communities they serve. Using Akvo’s example of data from Kambia (mapped in 2016) , we propose to highlight the extent of differences that can appear in coverage and access figures, when  parameters of functionality and population densities are also included into the calculations. These differences have far reaching ramifications on plans and policies that address safe water coverage across communities.

## Methodology for estimating water supply coverage using Sphere guidelines

###  Example 1: Measuring access by disaggregating type and functionality of water sources  (calculations based on *sphere guidelines*^[https://spherestandards.org/wp-content/uploads/Sphere-Handbook-2018-EN.pdf])

In the first example we wish to demonstrate how the coverage and access data is influenced by the type and functionality of the water points. We use data from a water point mapping in 2016 that was conducted in the district of Kambia, in Sierra Leone and district level population projections from the ministry^[https://www.statistics.sl/images/StatisticsSL/Documents/Census/2015/sl_2015_phc_thematic_report_on_population_projections.pdf]. The mapping survey used the following parameters to classify the water points:

- Improved water points (tap, handpump, open hand well, mechanised hand well)
- Unimproved water points (unprotected well, pond, river etc.)
- Total water points (total Improved and unimproved)
- Functional (functioning and in use) / not functional water points (defunct, damaged, under repair etc.)

The *Sphere Guidelines* provide a method to determine the number of people a specific type of water point can potentially serve i.e. projected coverage. Using the mapped data of Kambia, we have calculated the potential coverage as per these guidelines. The calculations show that if we were to  merely consider the total 750 water points mapped in Kambia in 2016, they can be expected to serve approximately 0.29 million people as per the guideline definitions. (Refer Table 1)



```{r example_1, echo=FALSE, message=FALSE, warning=FALSE}

table1 <- wp_2016_sub %>%
  group_by(ADM2) %>%
  summarise(
    "Total no. of water points" = n(),
    "Possible coverage (nr of people)" = sum(sphere_nr_people, na.rm=TRUE)
  ) %>% 
  rename(District = ADM2) %>%
  kbl("html", caption = "Table 1: Water points & estimated population coverage") %>%
  kable_styling("striped", position = "center", font_size = 11, full_width = FALSE) %>%
  add_footnote(c("National Water Point Mapping 2016", "Sphere guidelines"))

table2 <- wp_2016_sub %>%
  group_by(ADM2, sdg_improved_source) %>%
  summarise(
    "Number of water points" = n(),
    "Potential coverage (nr of people)" = sum(sphere_nr_people, na.rm=TRUE)
  ) %>% 
  rename("Improved/ unimproved water point" = sdg_improved_source,
         District = ADM2) %>%
  kbl("html", caption = "Table 2: Coverage of water points by category") %>%
  kable_styling("striped", position = "center", font_size = 11, full_width = FALSE)%>%
  add_footnote(c("National Water Point Mapping 2016", "Sphere guidelines"))

table3 <- wp_2016_sub %>%
  group_by(ADM2, Functionality) %>%
  summarise(
    "Number of water points" = n(),
    "Possible coverage (nr of people)" = sum(sphere_nr_people, na.rm=TRUE)
  ) %>% 
  rename("Functional / not  functional" = Functionality,
         District = ADM2) %>%
  kbl("html", caption = "Table 3: Functionality by type of water point") %>%
  kable_styling("striped", position = "center", font_size = 11, full_width = FALSE) %>%
  add_footnote(c("National Water Point Mapping 2016", "Sphere guidelines"))

# table4 <- wp_2016_sub %>%
#   group_by(Functionality, sdg_improved_source) %>%
#   summarise(
#     "Number of water points" = n()) %>% 
#   spread(sdg_improved_source, `Number of water points`) %>%
#   kbl("html", caption="Table 4: Functionality of water points") %>%
#   kable_styling("striped", position = "center", font_size = 11, full_width = FALSE) %>%
#   add_footnote(c("National Water Point Mapping 2016", "Sphere guidelines"))

# Population projections
pop_projections_city <- read.table(here("data/raw","pop_projections.csv"), sep=",", header=TRUE)
names(pop_projections_city) <- c("ADM2", "2016", "2018", "2020", "2022", "2024", "2026", "2028", "2030")

pop_projections <- pop_projections_city %>%
  mutate(across(c("2016":"2030"), ~ gsub(",", "", .))) %>%
  mutate(across(c("2016":"2030"), ~ as.numeric(.))) %>%
  mutate(City = ifelse(ADM2 %like% "City", "yes", "no")) %>%
  mutate(ADM2 = gsub(" District| City| Municipal", "", ADM2)) %>%
  group_by(ADM2) %>%
  summarise(across(c("2016":"2030"), ~ sum(.)))

# Population + improved water points
wp_coverage_ministry_pop_data_improved <- wp_2016_sub %>%
  group_by(ADM2, sdg_improved_source) %>%
  summarise(
    "Number of water points" = n(),
    "Possible coverage (nr of people)" = sum(sphere_nr_people, na.rm=TRUE)
  ) %>% 
  left_join(pop_projections %>% select(ADM2, `2016`) %>% mutate(`2016` = as.numeric(`2016`))) %>%
  mutate("Percentage of the population served (%)" = round(`Possible coverage (nr of people)`/`2016`,2)*100) %>%
  select(ADM2, sdg_improved_source, "Number of water points","Percentage of the population served (%)" ) 

wp_coverage_ministry_pop_data_functional <- wp_2016_sub %>%
  group_by(ADM2, sdg_improved_source, Functionality) %>%
  summarise("Number of water points" = n(),
    "Possible coverage (nr of people)" = sum(sphere_nr_people, na.rm=TRUE)) %>%
  arrange(sdg_improved_source) %>%
  left_join(pop_projections %>% select(ADM2, `2016`) %>% mutate(`2016` = as.numeric(`2016`))) %>%
  mutate("Percentage of the population likely to be served (%)" = round(`Possible coverage (nr of people)`/`2016`,2)*100)

pie_data_1 <- data.frame(
  methodology = c("Percentage likely to be served by improved wp (Ministy data 2016)",
                  "Percentage likely to be served by improved and functional wp (Ministy data 2016)"),
  percentage_served = c(76, 43)) %>%
  mutate(percentage_not_served = 100 - percentage_served) %>% melt()

pie_data_1 <- pie_data_1  %>%
  mutate(methodology = str_wrap(methodology, width = 25)) %>%
  mutate(methodology = factor(
    methodology,
    levels = c(
      "Percentage likely to be\nserved by improved wp\n(Ministy data 2016)",
      "Percentage likely to be\nserved by improved and\nfunctional wp (Ministy\ndata 2016)")))

table4 <- wp_coverage_ministry_pop_data_functional %>%
  rename(District = ADM2,
         "Functional / not  functional" = Functionality) %>% 
  ungroup(sdg_improved_source) %>%
  select(District, "Functional / not  functional", "Number of water points", "Possible coverage (nr of people)") %>%
  kbl("html", caption="Table 4 : Functionality of water points") %>%
  kable_styling("striped", position = "center", font_size = 11, full_width = FALSE) %>%
  add_footnote(c("National Water Point Mapping 2016", "Sphere guidelines"))

table5 <- wp_coverage_ministry_pop_data_functional %>%
  rename(District = ADM2,
         "Improved / unimproved" = sdg_improved_source,
         "Functional / not  functional" = Functionality) %>% 
  select(District, "Improved / unimproved" ,
         "Functional / not  functional", "Percentage of the population likely to be served (%)") %>%
  kbl("html", caption="Table 5: Population coverage of water points") %>%
  kable_styling("striped", position = "center", font_size = 11, full_width = FALSE) %>%
  add_footnote(c("National Water Point Mapping 2016", "Sphere guidelines"))
 
```

<br> `r table1` <br> 

The mapping data further classified 686 of the total water points as “improved” sources which, as per the Sphere guidelines, can potentially serve approximately 0.27 million people, see Table 2. As we show in Figure 1, the coverage proportions when the improved / unimproved categorization is done, reduces to 76%. If these water points are classified according to their functionality (refer table 3) the data reports only 433 as being functional. The coverage figures dip further to 43% when functionality is considered, as only 399  of the 433 water points were identified as improved and functional water points. When a water point is  an unimproved source or does not perform to its full potential, it is as good as being non-existent and cannot be considered as contributing to ‘coverage’,  since it does not ‘serve/cover’ the community  that it is intended to.

```{r pie1, fig.align="center", fig.width=6, fig.height=4, echo=FALSE, message=FALSE, warning=FALSE}
pie_data_1 <- pie_data_1 %>%
  mutate(variable = recode(
    variable, 
    percentage_served = "Percentage\n likely served", 
    percentage_not_served = "Percentage\n likely not served"))

ggplot(data = pie_data_1, aes(x = "", y = value, fill=variable )) + 
  geom_bar(stat = "identity", position = position_fill()) +
  scale_fill_manual(values = c( "#7868E6", "#B8B5FF")) +
  geom_text(aes(label = paste0(value, "%")), position = position_fill(vjust = 0.5), size=4,
            family="Assistant-Regular") +
  coord_polar(theta = "y") +
  facet_wrap(.~methodology, ncol=4)  +
  labs(title="Figure 1: Projected percentage of the population served", caption="National water point mapping 2016;\nMinistry population projections 2016") +
  theme(legend.position = "right",
        plot.title = element_text(size=12,
            family="Roboto-Regular", color="#687980"),
        strip.text = element_text(size=9, face="italic", color="black"),
        strip.background = element_rect(fill = "#E4FBFF", colour = NA),
        legend.title = element_blank(),
        axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.title.y = element_blank(),
        axis.text.y = element_blank()) + 
  guides(fill=guide_legend(nrow=2, byrow=TRUE))


## Bar graph WP status Kambia
# ggplot(wp_coverage_ministry_pop_data_functional, 
#        aes(x = sdg_improved_source, 
#            y=`Number of water points`, 
#            fill=Functionality, 
#            label=paste0(`Percentage of the population served (%)`,
#                         "%", "\nProjected to\nserve"))) +
#   scale_fill_manual(values=c("#A9F1DF", "#FC5404")) +
#   # ylim(c(0,75)) +
#   geom_bar(stat="identity", position="dodge") +
#   geom_text(data=wp_coverage_ministry_pop_data_functional %>% filter(Functionality=="Functional and in use"),
#             nudge_x = -0.25, nudge_y = 20, size=3) +
#   geom_text(data=wp_coverage_ministry_pop_data_functional %>% filter(Functionality=="Not functional"),
#             nudge_x = 0.25, nudge_y = 20, size=3) +
#   theme(legend.position = "right",
#         legend.title = element_blank(),
#         legend.text = element_text(size=10),
#         plot.title = element_text(size=14),
#         axis.text.x = element_text(size=12),
#         axis.title.x = element_blank(),
#         axis.text.y = element_text(size=8),
#         axis.ticks = element_blank())


```

<br> `r table2` <br> 

<br> `r table3` <br> 

In Table 4 we further provide details of the status of functionality of the mapped water points in Kambia. Only 336 of the 750 water points i.e. 45%, were reported to be functional and in use. From the rest, 300 water points i.e. 40% , were  reported to be broken down and the remaining were in various stages of non functionality and non use. This information provides sufficient evidence to highlight the need to look at types of functionality, to decide coverage / access of water points and brings to light the fact that having a water point does not necessarily ensure having access to water supply.                                                                             

<br> `r table4` <br>

*In summary, based on a national inventory, in 2016, there were approximately 355,469 people living in Kambia. Going by the projections, population figures of Kambia were expected to grow up to 375,191 by 2018. If we were to measure coverage by simply looking at the number of water points against the reported population in Kambia, 82% of the population would be shown as ‘served’ by the 750 (total) water points. When the same data is  distinguished between improved and unimproved categories, only 77% of the population in Kambia was found to be served by improved water points, see table 5. When the data is further disaggregated by functionality, i.e. whether the water points are functional or not, the coverage proportions are further reduced to 43%. This analysis helps us to understand the ‘real coverage’ and asserts the need for disaggregating data by type of source and functionality to decide the ‘real need’ for water supply across populations.*

<br> `r table5` <br> 

### Example 2: Measuring access vis a vis population density

Kambia is about 3000 square kilometers and is estimated to have about 800 villages. In order to decide whether communities are accessing water within 30 minutes for a round trip for collection (as required by the JMP to categorize as ‘basic’ services),  it is also important to know whether the water points are dispersed in a manner that that match the way communities are also dispersed, i.e. the population density.<b> In this example, we demonstrate a method to estimate access to water services in relation to the population densities in Kambia.</b> <br>

In Example 2, we first look at the population density of the location and then  compare it with the distribution of water points in the same locations, to estimate the concentration of people i.e. the number of people likely to be dependent on each water point.


```{r example_2, message=FALSE, warning=FALSE, include=FALSE}

# SL shape file data
sl.shape <-read_sf(dsn = here::here("data/raw/SIL_admin_SHP/", "SIL.shp"))
sl.shape.data <- ggplot2::fortify(sl.shape, region='NAME') %>%
  filter(ADM2 == "Kambia") %>%
  st_set_crs(4326) %>%
  st_transform(3035)

# SL waterways shape file data
sl.water.shape <-read_sf(dsn = here::here("data/raw/shapefiles/waterways/", "waterways.shp"))
sl.water.shape <- ggplot2::fortify(sl.water.shape) %>%
  st_set_crs(4326) %>%
  st_transform(3035)

water_ways_kambia <- st_intersection(sl.shape.data, sl.water.shape)

# Population data
fb_pop_sl <- read.csv2(here("data/raw", "population_sle_2019-07-01.csv"), sep=",")
fb_pop_sl <- fb_pop_sl %>%
  mutate(ID = paste0("V", rownames(fb_pop_sl))) %>%
  mutate(Lon = as.numeric(Lon)) %>%
  mutate(Lat = as.numeric(Lat)) %>%
  mutate(Population = as.numeric(Population))

fb_pop_kambia <- fb_pop_sl %>%
  filter(Lon > -14 & Lon < -12) %>%
  filter(Lat > 8 & Lat < 10)

FB_density_admin <- st_read(here("data/processed", "FB density with admin level.shp"))
```


```{r pop_density_and_wp, echo=FALSE, message=FALSE, warning=FALSE}

FB_density_admin_kambia <- FB_density_admin %>%
  filter(ADM2 == "Kambia") %>%
  mutate(Population = as.numeric(Population)) %>%
  st_transform(4269)

# POP DENSITY
ggplot() +
  geom_sf(data = FB_density_admin_kambia, aes(color=Population), alpha=0.8, size = 1) +
  theme_minimal() +
  scale_color_gradient(low="#d8c2f3", high="#845ec2", breaks=c(10,15,20,25,30,35)) +
  labs(title="Figure 2: Population density in Kambia", color="", caption= "FB population density data 2019")

## IMPROVED
ggplot() +
  geom_sf(data = water_ways_kambia %>%
  st_transform(4269), size = 0.5, color = "steelblue") +
  geom_point(data=wp_2016_sub,
             aes(x=Longitude, y=Latitude, fill=sdg_improved_source), shape=25,  stroke = 0.2, alpha=0.8)  +
  scale_fill_manual(values=c("green", "#FFCD60")) +
  labs(title="Figure 3: Water points in Kambia", x="", y="", caption="National water point mapping 2016") +
  theme(legend.position = "right",
        legend.title = element_blank(),
        legend.text = element_text(size=8),
        plot.title = element_text(size=14),
        axis.text.x = element_text(size=8),
        axis.text.y = element_text(size=8),
        axis.ticks = element_blank())

#"#1EAFED", "#FFCD60"
```

Figure 2 shows the distribution of  people and water points in Kambia.  On the left is the map showing the population density of Kambia, based on the 2019 Facebook density data. The darker the points on the map,  the more dense is the population. The population of Kambia  seems the least concentrated in the outer parts of the district, and the most number of people live  in the center and to the south western parts of the District.       

The map on the right in Figure 2 shows the density of water points in the district which are classified by type i.e. Improved/ unimproved sources. The dots in blue indicate ‘improved’ water sources and those in yellow are unimproved and the darker the colour the more close to each other are the points. The distribution of water points do not follow a pattern, but many communities in the district, especially in the outer fringes in the district, continue to depend on unimproved water supply. Also, the distribution of water points are not in sync with the population density, especially in the central part of the district. The comparison in densities of population and spread of water points becomes clearer when we look at Figure 3 where the parameters of Figure 2 have been overlaid with each other. The maps provide a good pointer to identify the ‘uncovered’ regions where more investments are needed to improve reach.


```{r graphs_combined, fig.align="center",  echo=FALSE, message=FALSE, warning=FALSE}

ggplot() +
  geom_sf(data = FB_density_admin_kambia, aes(color=Population), alpha=0.8, size = 1) +
  theme_minimal() +
  scale_color_gradient(low="#d8c2f3", high="#845ec2", breaks=c(10,15,20,25,30,35)) +
  geom_point(data=wp_2016_sub,
             aes(x=Longitude, y=Latitude, fill=sdg_improved_source), shape=25,  stroke = 0.2, alpha=0.8)  +
  scale_fill_manual(values=c("#1EAFED", "#FFCD60")) +
  labs(
    title="Figure 3: Comparison of Population density and water point density\nby type of water points",
    x="", y="", color="# of people/\n30-meter grid",
    caption="National water point mapping 2016; \nFB density data 2019")+
  theme(legend.position = "right",
        # legend.title = element_blank(),
        legend.text = element_text(size=8),
        plot.title = element_text(size=14),
        axis.text.x = element_text(size=8),
        axis.text.y = element_text(size=8),
        axis.ticks = element_blank())

# improved #1EAFED
# unimproved #FFCD60

# Functionality? "#A9F1DF", "#FC5404"

# green: low="#94d8d6", high="#018383"
# orange: #f98404 #ffcaa0
# purple: #845ec2 #d8c2f3
```

Figure 4  shows the location of the different water points in Kambia along with their functionality status. The highest concentration of water points are seen to be in the middle  and more to the southern part of the district and the lowest concentration is in the outer fringes. Along the eastern border there seem to be quite some non functional water points.

```{r functionality_map, echo=FALSE, message=FALSE, warning=FALSE}
## FUNCTIONALITY
ggplot() +
  geom_point(data=wp_2016_sub,
             aes(x=Longitude, y=Latitude, fill=Functionality), shape=25,  stroke = 0.2, alpha=0.8)  +
  scale_fill_manual(values=c("#A9F1DF", "#FC5404")) +
  theme_minimal() +
  labs(title="Figure 4 : Water point functionality in Kambia", x="", y="",
       caption="National water point mapping 2016") +
  theme(legend.position = "right",
        legend.title = element_blank(),
        legend.text = element_text(size=8),
        plot.title = element_text(size=14),
        axis.text.x = element_text(size=8),
        axis.text.y = element_text(size=8),
        axis.ticks = element_blank())

```

When the improved water points are further classified by functionality, the ‘coverage’ dips and we see many of the listed ‘covered’ regions to be having water points that are non or partially functional, and therefore not catering to their intended coverage. These visuals help planners and service providers to identify the focus areas for repair and maintenance and in reality should not be included as covered areas.

As shown in Figure 3, in Figure 5 when we overlay the population densities over the density of water points in Kambia using the functionality parameters, the  size of the uncovered population becomes larger. Clearly, there are sizable  sections of the communities in Kambia who do not have access to even basic water supply services and even larger numbers who may be considered ‘covered’ but in reality receive none or sub normal services and probably depend on  walking long distances to collect water from the closest functioning water source or resort to unimproved and unsafe water sources.


```{r graphs_combined_improved_functional,  echo=FALSE, message=FALSE, warning=FALSE}

ggplot() +
  geom_sf(data = FB_density_admin_kambia, aes(color=Population), alpha=0.8, size = 1) +
  theme_minimal() +
  scale_color_gradient(low="#d8c2f3", high="#845ec2", breaks=c(10,15,20,25,30,35)) +
  geom_point(data=wp_2016_sub %>%
               filter(sdg_improved_source == "improved") %>%
               filter(Functionality == "Functional and in use"),
             aes(x=Longitude, y=Latitude, fill=Functionality), shape=25,  stroke = 0.2, alpha=0.8)  +
  scale_fill_manual(values=c("#1EAFED", "#FFCD60"), labels=c("Improved and functional", "Not functional")) +
  labs(
    title="Figure 5 : Comparison of population and water point density\nby functionality of improved water points",
    caption="National water point mapping 2016; \nFB density data 2019",
    color="# of people/\n30-meter grid",
    x="", y="") +
  theme(legend.position = "right",
        legend.text = element_text(size=8),
        plot.title = element_text(size=14),
        axis.text.x = element_text(size=8),
        axis.text.y = element_text(size=8),
        axis.ticks = element_blank())

```

## Using Population projections to estimate projected need for water services


If we want to see how many people live close enough to the water points for the water supply to be considered "basic" water service level, we need to combine the population density data with the water point locations. By taking an area around the water point and determining how many people live within that area, we can first determine the population that is close enough to the water point. Next, we will compare the amount of people to the amount of people the water point can serve based on the sphere guidelines. By looking at the intersection and comparing that to the total population we can determine the percentage of the population actually served. Below we will follow these steps one by one.

1. Draw a circle around the water points that represents the 30 min round trip. We will use a 500m radius, which represents a 1 kilometer walk back and forth. This allows for additional time that comes from following a road and some time for queuing. 
2. Account for overlapping circles.
3. Determine the population living withing the 500m radius of a water point.
4. Compare the population living within the radius to the capacity of the water point. 
5. Include the population living outside of the radius to determine the percentage of the population likely to be served by the water point.

```{r wp_density, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}
ggplot(sl.shape.data) +
  geom_sf(size = 0.1, color = "#603f83ff", fill="#f2f2f2") +
  theme_minimal() +
  geom_point(data=wp_2016_sub,
             aes(x=Longitude, y=Latitude, color=Functionality),
             size = 2, alpha=1, shape=20) +
  scale_color_manual(values=c("#006d2c", "#810f7c")) +
  labs(title="2016 Waterpoint mapping SL: Kambia", x="", y="") +
  theme(legend.position = "right",
        legend.title = element_blank(),
        legend.text = element_text(size=8),
        plot.title = element_text(size=14),
        axis.text.x = element_text(size=8),
        axis.text.y = element_text(size=8),
        axis.ticks = element_blank())
```


```{r wp_improved, echo=FALSE, message=FALSE, warning=FALSE}
# Convert the water point geolocation to geometry, set the crs to EPSG:4326 (lat/long), and transform to EPSG:3035
wp_2016_sf <- st_as_sf(
  wp_2016_sub,
  coords = c( "Longitude", "Latitude"),
  crs = 4326) %>%
  st_transform(3035)

# Create a buffer of a 500m radius
wp_2016_circles <- st_buffer(wp_2016_sf, dist = 500)

# Make sure the shape file has the same crs
sl.shape <- sl.shape %>% st_set_crs(4326) %>%
  st_transform(3035)

# Intersect water point circles with the shape file to account for overlapping water points
wp_2016_int_circles <- st_intersection(sl.shape, wp_2016_circles)

# Make sure the population data has the same crs
pnts_sf <- st_as_sf(fb_pop_sl,
                    coords = c( "Lon", "Lat"),
                    crs = 4326) %>%
  st_transform(3035)

# Identify the population that falls within the water point radius
kept_points_with_ID <- st_intersection(wp_2016_int_circles, pnts_sf)

## ONLY IMPROVED
improved_kept_points_with_ID_no_geometry <- kept_points_with_ID %>%
  st_drop_geometry() %>%
  filter(sdg_improved_source == "improved")

improved_kept_points_with_ID_no_geometry <- improved_kept_points_with_ID_no_geometry %>%
  select(Water.point.Name, ADM2, sphere_nr_people, ID.1, Population) %>%
  mutate(Population = as.numeric(Population)) %>%
  unique()

# Duplicates:
improved_duplicate_pop_density <- improved_kept_points_with_ID_no_geometry %>%
  group_by(ID.1) %>%
  summarise(count=n())

improved_kept_points_with_ID_no_geometry <- improved_kept_points_with_ID_no_geometry %>%
  left_join(improved_duplicate_pop_density) %>%
  mutate(Population = Population/count)

improved_kept_points_with_ID_no_geometry <- improved_kept_points_with_ID_no_geometry %>%
  group_by(Water.point.Name, ADM2, sphere_nr_people) %>%
  summarise(Population_within_circle = sum(Population, na.rm=TRUE))

# Show percentage of population served within the 500m radius
# and show percentage of the population that lives outside of the 500m radius
improved_wp_coverage_fb_density <- FB_density_admin_kambia %>%
  st_drop_geometry() %>%
  mutate(Population = as.numeric(Population)) %>%
  group_by(ADM2) %>%
  summarise(Total_pop_fb = sum(Population)) %>%
  left_join(improved_kept_points_with_ID_no_geometry %>%
              group_by(ADM2) %>%
              summarise(sphere_nr_people = sum(sphere_nr_people, na.rm=TRUE),
                        Population_within_circle = sum(Population_within_circle, na.rm=TRUE))) %>%
  mutate(Population_outside_circle = Total_pop_fb - Population_within_circle) %>%
  mutate("Percentage served within 500m radius" = round(sphere_nr_people/Population_within_circle,2)*100) %>%
  mutate(Percentage_pop_outside_circle = round(Population_outside_circle/Total_pop_fb,2)*100) %>%
  mutate("Actual percentage served within 500m radius" = ifelse(
    `Percentage served within 500m radius`>100, 100, `Percentage served within 500m radius`)) %>%
  mutate(actual_pop_served = Population_within_circle*(`Actual percentage served within 500m radius`/100)) %>%
  mutate("Actual percentage of the population served" = round(
   actual_pop_served/Total_pop_fb,2)*100)

improved_wp_coverage_fb_density %>%
  rename(
    District = ADM2,
    "Total population" = Total_pop_fb,
    "Projected percentage of the population served by the water point (in the 500m radius)"= "Actual percentage served within 500m radius",
    "Projected percentage of the population depending the water supply" = "Actual percentage of the population served") %>%
  select(District, "Total population", 
         "Projected percentage of the population served by the water point (in the 500m radius)",
         "Projected percentage of the population depending the water supply" ) %>% melt() %>%
  kbl("html", caption="Table 7 (a): Population covered  by ‘improved’ water points") %>%
  kable_styling("striped", position = "center", font_size = 11, full_width = FALSE) %>%
  add_footnote(c("National water point mapping 2016", "FB density 2019"))
 

```

In Table 6, we note that the projected population of Kambia was likely to be 366,828 in 2019. About 70% of people living around a water source within 500 meter radius would be projected to be served by a water point. However, when we overlay the actual population in the same radius, only 38% of people would be expected to be covered.

```{r projected_map, echo=TRUE, message=FALSE, warning=FALSE}

# summarise the population density per water point
# population_dens_per_wp <- improved_kept_points_with_ID_no_geometry %>%
#   group_by(Water.point.Name, ADM2, sphere_nr_people) %>%
#   summarise(Population_within_circle = sum(Population, na.rm=TRUE))
# 
# population_dens_per_wp <- population_dens_per_wp %>%
#   mutate(sphere_nr_people = replace_na(sphere_nr_people, 0)) %>%
#   mutate(Percentage_served_within_circle = round(sphere_nr_people/Population_within_circle,2)*100) %>%
#   mutate(percentage_actually_served = ifelse(Percentage_served_within_circle > 100, 100, Percentage_served_within_circle))
# 
# pop_served <- wp_2016_int_circles %>%
#   st_transform(4269) %>%
#   left_join(population_dens_per_wp)
# 
# ggplot() +
#   geom_sf(data = pop_served, aes(color=percentage_actually_served), alpha=0.8, size = 1) +
#   theme_minimal() +
#   scale_color_gradient(low="#d43d51", high="#6aaa96", breaks=c(25, 50, 75, 100)) +
#   labs(title="Figure 5: Proportion of the population projected to served", color="")


```

## Example 2: Making projections for access to ‘Improved’ and functional  water points

As per the JMP, only water points that classify as ‘improved’ can be considered to be providing ‘basic’ services for water supply. Hence, while estimating the need of future populations it is imperative to identify proportions of the population who presently  have access to only improved water points and then decide on how much more is needed for the projected populations.  Figure 7  shows what happens to the population statistics when we segregate improved and later functional water sources, within the total water points  in Kambia. Compared to the information in Table 6 in the previous example where the coverage was shown as 43%, we find that when only ‘improved’ water points are considered, the proportion of people served  reduces to 38%. This is because some communities are still dependent on unimproved water sources or surface water and are therefore excluded in the calculations. Further, when the improved water points are checked for ‘functionality’ i.e. whether they are dispensing water to their full potential and are being used, the coverage goes down to about 19%.

Tables 7(a) and 7(b) provide details of how the coverage data changes when we consider only the  improved and functional water points that are not damaged and in use at time of the data collection:

```{r wp_functional, echo=FALSE, message=FALSE, warning=FALSE}

## ONLY IMPROVED & FUNCTIONAL

functional_kept_points_with_ID_no_geometry <- kept_points_with_ID %>%
  st_drop_geometry() %>%
  filter(sdg_improved_source == "improved") %>%
  filter(Functionality %in% c("Functional and in use" )) %>%
  select(Water.point.Name, ADM2, sdg_improved_source, sphere_nr_people, ID.1, Population) %>%
  mutate(Population = as.numeric(Population)) %>%
  unique()

# Duplicates:
functional_duplicate_pop_density <- functional_kept_points_with_ID_no_geometry %>%
  group_by(ID.1) %>%
  summarise(count=n())

functional_kept_points_with_ID_no_geometry <- functional_kept_points_with_ID_no_geometry %>%
  left_join(functional_duplicate_pop_density) %>%
  mutate(Population = Population/count)

functional_kept_points_with_ID_no_geometry <- functional_kept_points_with_ID_no_geometry %>%
  group_by(Water.point.Name, ADM2, sphere_nr_people) %>%
  summarise(Population_within_circle = sum(Population, na.rm=TRUE))

# Show percentage of population served within the 500m radius
# and show percentage of the population that lives outside of the 500m radius
functional_wp_coverage_fb_density <- FB_density_admin_kambia %>%
  st_drop_geometry() %>%
  mutate(Population = as.numeric(Population)) %>%
  group_by(ADM2) %>%
  summarise(Total_pop_fb = sum(Population)) %>%
  left_join(functional_kept_points_with_ID_no_geometry %>%
              group_by(ADM2) %>%
              summarise(sphere_nr_people = sum(sphere_nr_people, na.rm=TRUE),
                        Population_within_circle = sum(Population_within_circle, na.rm=TRUE))) %>%
  mutate(Population_outside_circle = Total_pop_fb - Population_within_circle) %>%
  mutate("Percentage served within 500m radius" = round(sphere_nr_people/Population_within_circle,2)*100) %>%
  mutate(Percentage_pop_outside_circle = round(Population_outside_circle/Total_pop_fb,2)*100) %>%
  mutate("Actual percentage served within 500m radius" = ifelse(
    `Percentage served within 500m radius`>100, 100, `Percentage served within 500m radius`)) %>%
  mutate(actual_pop_served = Population_within_circle*(`Actual percentage served within 500m radius`/100)) %>%
  mutate("Actual percentage of the population served" = round(
   actual_pop_served/Total_pop_fb,2)*100)

functional_wp_coverage_fb_density %>%
  rename(
    District = ADM2,
    "Total population" = Total_pop_fb,
    "Projected percentage of the population served by the water point (in the 500m radius)"= "Actual percentage served within 500m radius",
    "Projected percentage of the population depending the water supply" = "Actual percentage of the population served") %>%
  select(District, "Total population", 
         "Projected percentage of the population served by the water point (in the 500m radius)",
         "Projected percentage of the population depending the water supply" ) %>% melt() %>%
  kbl("html", caption=" Table 7 (b) : Population covered by functional and improved water points") %>%
  kable_styling("striped", position = "center", font_size = 11, full_width = FALSE) %>%
  add_footnote(c("National water point mapping 2016", "FB density 2019"))

```

*In summary, in Figure 8 we can see how the proportion of coverage decreases at each stage of calculation. The first chart shows the  commonly reported water coverage data when we consider the total number of water points in a region. For Kambia, in 2016, 77% of the population were  reported to be covered with improved water points. The second chart  shows that  by comparing coverage with the population density, the likely coverage would go down to 43%. When we further qualify population density by also looking at how many people walk less than 30 minutes to collect their water, the coverage proportion reduces to 38%. Lastly, when the water sources are disaggregated by type i.e. only improved water point and functionality i.e. are functional and in use and within a 30 minute distance, the coverage becomes only 24%.*

```{r visuals1, fig.align = "center", echo=FALSE, message=FALSE, warning=FALSE}


pie_data <- improved_wp_coverage_fb_density %>%
  select(ADM2, "Actual percentage of the population served") %>%
  rename(percentage_served = `Actual percentage of the population served`) %>%
  mutate(percentage_not_served = 100 - percentage_served) %>% melt() %>%
  mutate(methodology = "Percentage likely to be served by improved wp (FB density data 2019)") %>%
  full_join(
    functional_wp_coverage_fb_density %>% select(ADM2, "Actual percentage of the population served") %>%
      rename(percentage_served = `Actual percentage of the population served`) %>%
      mutate(percentage_not_served = 100 - percentage_served) %>% melt() %>%
      mutate(methodology = "Percentage likely to be served by improved and functional wp (FB density data 2019)")) %>%
  mutate(variable = recode(
    variable, 
    percentage_served = "Percentage\n likely served", 
    percentage_not_served = "Percentage\n likely not served"))

pie_data <- pie_data  %>%
  mutate(methodology = str_wrap(methodology, width = 20))  %>% 
  full_join(pie_data_1) %>%
  mutate(methodology = factor(
    methodology,
    levels = c("Percentage likely to be\nserved by improved wp\n(Ministy data 2016)",
               "Percentage likely to be\nserved by improved and\nfunctional wp (Ministy\ndata 2016)",
               "Percentage likely\nto be served by\nimproved wp (FB\ndensity data 2019)",
               "Percentage likely\nto be served\nby improved and\nfunctional wp (FB\ndensity data 2019)")))

ggplot(data = pie_data, aes(x = "", y = value, fill=variable )) +
  geom_bar(stat = "identity", position = position_fill()) +
  scale_fill_manual(values = c( "#7868E6", "#B8B5FF"), labels=c("Percentage\n likely served",
                                                                "Percentage\n likely not served")) +
  geom_text(aes(label = paste0(value, "%")), position = position_fill(vjust = 0.5),
            size=4,
            family="Assistant-Regular") +
  coord_polar(theta = "y") +
  facet_wrap(.~methodology, ncol=4)  +
    labs(title="Figure 7: Population served by improved points and functional points", 
         caption="National water point mapping 2016;\nMinistry population projections 2016") +
  theme(legend.position = "right",
        plot.title = element_text(size=12,
            family="Roboto-Regular", color="#687980"),
        strip.text = element_text(size=9, face="italic", color="black"),
        strip.background = element_rect(fill = "#E4FBFF", colour = NA),
        legend.title = element_blank(),
        axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.title.y = element_blank(),
        axis.text.y = element_blank()) +
  guides(fill=guide_legend(nrow=2, byrow=TRUE))


```


# Annex 1: data sources

## National Water Point mapping 2016^[https://washdata-sl.org/water-point-data/]
The Sierra Leone WASH portal is a comprehensive mapping exercise carried out by the Ministry of Water Resources (MOWR) and its partners in 2016. Over 28,000 public improved water points across all of Sierra Leone’s districts and chiefdoms have been mapped during this period. The exercise constitutes a comprehensive update of the earlier mapping in 2012. 

## Sphere guidelines

The Sphere movement was started in 1997 by a group of humanitarian professionals aiming to improve the quality of humanitarian work during disaster response. With this goal in mind, they framed a Humanitarian Charter and identified a set of humanitarian standards to be applied in humanitarian response. During a disaster the standards for water supply are generally lower than for normal domestic use. Because of the nature of humanitarian response using the Sphere guidelines might cause the numbers to be more favorable than they actually are. 

## Sierra Leone 2015 Population and Housing CensusThematic Report on Population Projections

## High Resolution Population Density Maps
Accurate population density data is critical for delivery of social services. Facebook has built the world’s most accurate population maps using satellite imagery.

</div>